\documentclass[12pt, a4paper]{article}
%\usepackage[pdftex,dvipsnames]{color}
\usepackage{graphicx}
\usepackage{times}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{url}
\usepackage{amsmath}
\usepackage{amsfonts}

\usepackage[pdfstartview={},
            pdftex,
            bookmarks=true,
            bookmarksopen=true,
            bookmarksnumbered=true,
            ]{hyperref}

\newcommand{\eps}{\varepsilon}
\newcommand{\abso}[1]{\;\mid#1\mid\;}
\renewcommand{\=}{\,=\,}
\newcommand{\+}{\,+\,}
% ----------------------------------------------------------------
\newcommand{\remark}[1]{\par\noindent{\color[named]{ProcessBlue}#1}\par}
\newcommand{\mcc}[2]{\multicolumn{#1}{c}{#2}}
\newcommand{\mcp}[2]{\multicolumn{#1}{c|}{#2}}
\newcommand{\nm}[1]{\textsf{\small #1}}
\newcommand{\nnm}[1]{\textsf{\small\textit{#1}}}
\newcommand{\nmm}[1]{\nnm{#1}}
\newcommand{\sfn}[1]{\textbf{\texttt{#1}}}
\newcommand{\bs}{\backslash}

% no labels in list of references:
\makeatletter
\renewcommand\@biblabel{}
\makeatother

\hyphenation{Snij-ders Duijn DataSpecification dataspecification
  dependentvariable ModelSpecification}

\makeatother


\renewcommand{\baselinestretch}{1.0} %% For line spacing.
\setlength{\parindent}{0pt}
\setlength{\parskip}{1ex plus1ex}
\raggedright
\oddsidemargin 0in
\evensidemargin 0in
\textwidth 6.25in
\textheight 9.9in
\topmargin -2cm
\begin{document}

\title{\vspace*{-0.5cm} Notes for Developers of RSiena}
\author{Ruth Ripley (with some additions by Tom Snijders)}
\date{}
\maketitle

\centerline{\emph{\today}}
\bigskip

The introduction to the RSiena manual describes the basics of how to run the
program, either `standalone' or within R. The help files in R describe how to
use the R commands. Here are some notes for developers. Caveat: the information
recorded here gets out of date from time to time. Do not be surprised if things
do not work. Consult the appropriate original documentation or google to solve
the problem.

\section{Documentation}
\subsection{Getting the documentation: Windows Users}
\begin{enumerate}
\item Install TortoiseSVN. This will also install \textsf{svn}
    and a version of \textsf{plink}.\\
    Installation of TortoiseSVN may be sensitive. It is advised to
    install it when no other programs are running, and after installing
    to restart your computer immediately.
    A successful installation will show by having items
    SVN Checkout and TortoiseSVN
    in the popup window opening at a right mouse click in Windows Explorer.
\item If you have not already done so, \emph{register} on r-forge and ask to
  join RSiena.
\item When you get an email saying you have been allowed to join RSiena,
  go to R-forge RSiena SCM tab at
  \url{https://r-forge.r-project.org/scm/?group_id=461} and find the address of
  the repository:
\url{svn+ssh://developername@svn.r-forge.r-project.org/svnroot/rsiena}
\item Go into Windows Explorer and create a folder to hold the source files.
\item Navigate to this directory.
\item Right-Click and select SVN Checkout...
\item Paste the repository address in the top box, replace the word
  \emph{developername} by your r-forge user name and hit OK
\item When it finishes, you will have the source of RSiena and RSienaTest, in
  subdirectories of the \textsf{pkg} directory.
\item Each of RSiena and RSienaTest has the same basic layout of files, but
  RSienaTest has some extras: documentation source.
\item The documentation is in RSienaTest/doc.
\end{enumerate}
\subsection{Getting the documentation: non-Windows Users}
\begin{enumerate}
\item If you have not already done so, \emph{register} on r-forge and ask to
  join RSiena.
\item When you get an email saying you have been allowed to join RSiena, go to
  R-forge RSiena SCM tab at
  \url{https://r-forge.r-project.org/scm/?group_id=461} and find the checkout
  command: \sfn{\small svn checkout
    svn+ssh://developername@svn.r-forge.r-project.org/svnroot/rsiena} replacing
\verb|developername| by your name.
\item Create a folder to hold the source files.
\item In a terminal window, navigate to this directory.
\item Type the checkout command.
\item On Macs, you could try using \textsf{svnX} rather than the terminal
  interface.
\item When it finishes, you will have the source of RSiena and RSienaTest, in
  subdirectories of the \textsf{pkg} directory.
\item Each of RSiena and RSienaTest has the same basic layout of files, but
  RSienaTest has some extras: documentation source.
\item The documentation is in RSienaTest/doc.
\end{enumerate}
\subsection{Automatically generated documentation}
\begin{description}
\item[C]
\begin{enumerate}
\item Install \sfn{Doxygen} and \sfn{GraphViz}
\item Use the configuration file \sfn{RSienaTest/doc/config.dox} to run the
  Doxywizard. On Windows you need the File/Open \texttt{config.dox} (in
  \texttt{RSienaTest/doc}).  On a Mac, you need to use the expert/dot tab in the
  Wizard, and enter \texttt{/usr/local/graphviz-n.nn/bin} in the box marked
  DOT\_PATH where n.nn indicates the version. On
  Linux I do not know!
\item The documentation is a set of html files. Open one and then you can
  navigate round the set.
\end{enumerate}
\item[R]
\begin{enumerate}
\item Run the function \sfn{RSiena:::getRSienaRDocumentation()} with the
  argument set to the path to your R source files for RSiena or RSienaTest.
\item This generates a .csv file, a latex table or an R data frame (called
  tmp12) with details of the functions in. To make the csv more readable,
  autofit the columns and save as .xls.
\item NB You need RTools (see later) installed to do this on Windows.
\end{enumerate}
\item[R: Table of functions for the manual]
\begin{enumerate}
\item The file \sfn{document.r} in \sfn{RSienaTest} contains a function
  \sfn{RSienaAutoHelpTable} which will generate \LaTeX source  from the .Rd
  files for a table of functions similar to that in the manual
\item You need to run \sfn{RSienaAutoHelpTables} and then run \LaTeX on the file
  \sfn{auto.tex} in the doc directory of the source (not installed) package.
\item It is controlled by a data frame of functions hard coded in the file
  \sfn{document.r}.
\item The text is based on the \sfn{Description} field in the .Rd file. Moving
  information from this field to the \sfn{Details} field should allow sufficient
  flexibility to get the required table.
\item There are a few sample text processing commands commented out in the
  source file \sfn{document.r} which might prove useful.
\end{enumerate}
\end{description}
\subsection{Other documentation}
\label{S_otherDoc}
There are other documentation files:
\begin{description}
\item[RSienaSpec] Specification of the R side.  Details of creation of objects
  and \nnm{siena07} Robbins-Monro algorithm.
\item[simstats0c] Specification of C++ simulation for forward simulation
\item[maxlikec] C++ simulation for maximum likelihood estimation
\item[bayes] Bayesian function
\item[sienaTimeFix] Details of the implementation of testing for time
  heterogeneity and creation of time dummies.
\item[classdesign] Details of the C++ side.
\item[missingsEtc] Details of the treatment of missing values and structural
  values. Also describes processing of composition change.
\end{description}
This file contains a description of some ways of adapting the algorithms.

There are also a file called siena\_algorithms4,
which contain descriptions of the algorithms. It do not always match the
code, whereas I hope the files referred to above do.
\section{Updating the package on R-forge}
\subsection{A few notes about svn}
I am not an expert on this, and you do not need to know much. But a few notes
may help.
\begin{itemize}
\item R-forge will allow source files to be updated only if you have performed a
  developer secure checkout. Previously I suggested doing a read-only checkout
  first, but I now think that this is not a good idea. I recommend you go
  straight to a secure checkout and remove any other version of the r-forge
  source which you may have lying around.
 \item To make a change, edit the files you checked out and use \textsf{svn
     commit} from the same directories as you checked them out into.
 \item To get the most recent source at any time after checking out, use
   \textsf{svn update}. (A Right-click option on the directory in Windows
   Explorer for Windows users)
\item It is a good idea to do \textsf{svn update} before \textsf{svn commit}, as
  you will find out about conflicts and can solve them rather than leaving the
  repository in a conflicted state.
\item But \emph{never} do \textsf{svn update} and then copy your new versions on
  top of the updated files. This way you remove any changes between your
  checkout and the update. If you do risk this and rely on checking the
  differences, you must check for alterations in the blank spaces as well or you
  risk annoying someone who has reformatted code by removing their changes.
\item If you wish to rename or delete a file under svn control, use the svn
  options to do it. On Windows this is available via right-click from Tortoise.
\item If you add new text files of any type, set the svn property
  \textsf{eol-style} to have value \textsf{native}.  Again, available via
  Tortoise on Windows, via svnX on Mac.
\item Details of how to set up a personal/private key pair are in section
  \ref{key}. This removes the need to type your password multiple times.
\end{itemize}
\subsection{Files which always need updating}
 Before you commit an update to R-forge please do the following:
\begin{enumerate}
\item Record details of the files you have changed in the Changelog for
  RSienaTest. If you have \emph{only} changed documentation files in
  \textsf{RSienaTest/doc} directory, you may ignore the remainder of this
  section.
\item Record details of the files you have changed in the Changelog for RSiena.
  The two changelogs are kept identical, apart from changes which only affect
  the documentation source, otherwise it gets very confusing.
\item Update the version number and date in the \textsf{DESCRIPTION} file for
  each package.
\item Update the version number and date in \textsf{man/RSiena-package.Rd} in
  each package.
\item If the change would be noticeable to the users, add the details to the
  change log at the end of the manual. Create a new pdf and copy to the inst/doc
  directory of each package.
\end{enumerate}

And for changes in documentation files:
\begin{enumerate}
\item If you changed the manual \textsf{RSiena\_Manual.tex}, then include the
  changed .tex file as \textsf{$\bs$pkg$\bs$RSienaTest$\bs$inst$\bs$doc$\bs$RSiena\_Manual.tex} and
  \textsf{$\bs$pkg$\bs$RSiena$\bs$inst$\bs$doc$\bs$RSiena\_Manual.tex},
  and the changed .pdf file as
  \textsf{$\bs$pkg$\bs$RSienaTest$\bs$inst$\bs$doc$\bs$RSiena\_Manual.pdf} as well as
  \textsf{$\bs$pkg$\bs$RSiena$\bs$inst$\bs$doc$\bs$RSiena\_Manual.pdf}. The same for \textsf{RSiena.bib}.
  These three files should be identical for \textsf{RSiena} and \textsf{RSienaTest}.
\item For both packages separately:\\
  If the set of effects was changed, make a new \textsf{effects.pdf} file by
  calling the function \textsf{effectsDocumentation(type = "latex")} and compiling
  this by \LaTeX, and include this as \textsf{$\bs$pkg$\bs$RSienaTest$\bs$inst$\bs$doc$\bs$effects.pdf}.
\end{enumerate}

\section{Coding standards etc}

I describe below the main details of our current practice: for other points
please copy what you see!

For the convenience of any emacs users, I have added my Windows emacs
initialization file \sfn{\_emacs} to the doc directory of RSienaTest. It will
format R and C++ more or less to standards. If you want to use the package on
Mac or Windows, I recommend the versions on Vincent Goulet's Site
\url{http://vgoulet.act.ulaval.ca/en/emacs/} which come packaged with ess (for
R) and auctex (for \LaTeX). For Windows, put \sfn{\_emacs} in ``c:\textbackslash
documents and settings\textbackslash user name\textbackslash
AppData\textbackslash roaming'' (Windows Vista or 7) or ``c:\textbackslash
documents and settings\textbackslash user name\textbackslash Application Data''
(Windows XP). On Mac or Linux, the initialization file should be called
\sfn{.emacs}, located in your home directory, and it might need minor amendment
from \sfn{\_emacs}.

Note that emacs has a nice habit of copying text as soon as you highlight it and
then you can paste it with a right (Windows with my initialization file) or
middle button (Linux) click.

Note that \sfn{WinMerge} is a very helpful freeware tool for comparing files and folders;
it can be used to compare different versions of the package,
and to transfer parts of files to each other.
It can be integrated with Tortoise, but it is great to use it
independent of Tortoise.

\subsection{General}
\begin{enumerate}
\item Don't forget that data may be arrays but also sparse matrices.
\item When you modify the program or add to it, please try to modify
      correspondingly
      the documentation files mentioned in Section~\ref{S_otherDoc}:
      RSienaSpec, simstats0c, maxlikec, bayes, sienaTimeFix, classdesign,
      missingsEtc.
      It is of course very useful to consult this documentation before making
      a change.
      I (TS) realize that I have not always modified this documentation
      and it would be better if I had.
\item Use spaces: particularly around operators and after commas. (But
  not after the end of your lines!)
\item Do not use underscores: use variable names made up of several (possibly
  abbreviated, but ideally not) words with all but the first capitalised.
\item Use braces even when not strictly necessary in \sfn{if} and \sfn{for}
  statements and similar. (Not universal yet, but I am adding them...)
\item Align braces under each other (so put the first one on a new line). (I
  break this rule for \sfn{switch} statements in R as emacs does not do the
  alignment sensibly!)
\item Remove trailing spaces and tabs. (Emacs and Notepad++ have special
  commands for this).
\item Use tabs for indenting code and spaces for indenting \sfn{.Rd}
  documentation files (in view of how the latter are represented in html).
\item Set tabs at intervals of 4 columns.
\item Indent by 4.
\item Align comments in the body of the code with the surrounding code.
\item Do not use lines longer than 80 characters in any file, even
  documentation.
\item New source files need their \sfn{eol-style} set to \sfn{native} when they
  are added to the repository. On Windows, right-click and select
  Tortoise-SVN/properties then add \sfn{eol-style:native}.  (One current
  exception here: the file \sfn{sienascript} needs to have always unix line
  endings. Otherwise a tarball built on Windows will not produce a usable
  \sfn{sienascript} for Mac or Linux. There may be others in the future.)
\item Copy a file header from an existing source file, and adapt it.
\item Ensure your editor removes all trailing spaces.\\
  Note that in Notepad++ there is a command Edit/Blank Operations/Trim trailing
  space and also a macro Trim Trailing and Save (Alt+Shift+S).
\end{enumerate}
\subsection{R}
\begin{enumerate}
\item Use \verb|<-| rather than \verb|=| for assignment.
\item Use \sfn{TRUE} and \sfn{FALSE} not \sfn{T} and \sfn{F}.
\item Avoid unnecessary \sfn{for} loops. They are acceptable where a complicated
  \sfn{apply} statement would be necessary, but not where a simple vectorised
    command could be used.
  \item \sfn{R} functions need a documentation comment preceding the function
    declaration. If they have internal functions a call to \sfn{getInternals} is
    required also.
  \item \sfn{R} functions which are to be visible to the user need to be added
    to the \sfn{NAMESPACE} file, and have a help page for them : see the Writing
    R Extensions manual for the details of the format.
  \item Check that \sfn{R CMD check} works with no warnings apart from line
    endings (these are set to follow the platform, and will be OK when checked
    out on a Linux box).
  \item If writing methods, add them to the \sfn{NAMESPACE} file. Ensure that
    you get no warnings from them.
  \item \sfn{print} methods should invisibly return their argument.
  \item \sfn{summary} methods for class \sfn{objclass} should return an object
    of class \sfn{summary.objclass} which is printed by a
    \sfn{print.summary.objclass} method.
\item Avoid using the names of \sfn{R} functions as variable names. It is
  permitted but may lead to confusion.
\item Never rely on partial matching of function arguments.
\end{enumerate}
\subsection{C++}
\begin{enumerate}
\item Use \texttt{this-\textgreater} even when not strictly necessary.
\item If you add new files or functions, ensure they are
  Doxygen-documented by copying the comment structure at the start of file or
  function from a similar one.
\item Only include files in header files if absolutely necessary: use forward
  declaration instead.
\item All data items in classes are to be private: if derived classes need
  access provide a protected method for them.
\item Arguments lists should each be on a separate line unless all will fit on a
  single line.
\item Only declare one variable per line.
\item Use upper case for the preprocessor comments at the beginning and end of
  the header files.
\item Put comments before blocks such as Forward declarations, Class
  definitions.
\item More details of the design are in the document \emph{classdesign.tex}.
\item In particular note the naming conventions described there.
\end{enumerate}
\section{Recreating the package}
These notes apply to using R 2.12.0 or later. Please ensure you have the
latest source (which does not include commands to get the installer for
\verb|siena.exe|). If you do not then the behavior will not be as documented
below.
\begin{enumerate}
\item If using Windows, download and install the matching
\textsf{Rtools.exe} from
  CRAN. (The link is via Download R for Windows). Beware: if you later install
  other programs containing utilities such as tar (delphi is one offender), you
  may need to uninstall and reinstall Rtools, as you need Rtools at the start of
  your path. (Or edit the path!).\\
  The path must start with 
  \verb|C:\Rtools\bin;C:\Rtools\gcc-4.6.3\bin;|
  (if 4.6.3 is the correct version number);
  after that must follow the path to the R executable.\\
  To change the path in Windows 7:\\
  Open System Properties (e.g., right-click My Computer and select Properties);
   go to Advanced System Settings;
    select the Advanced tab, then click Environment Variables;
    under the System Variables section, select Path;
    edit the Path, taking care that what is previously there is left intact;
    click OK on each of the dialogs to save your settings.
    Restart your computer.  
\item If using a Mac, you will need the Xcode tools installed.
\item Obtain the current source using a developer secure checkout.
\item In a command prompt window, navigate to the directory above the siena
  tree. Here I assume it is called \sfn{RSiena}. (You may have minor
  difficulties if it is not!)
\item Type\\
\verb|R CMD build RSiena|
\item You will probably need to either add R to your path, or use
  `path-to-R.exe' in the command above.
\item You may get warning messages from CYGWIN. This is caused by a recent
  upgrade in RTools version 2.12. To suppress the warnings, set the environment
  variable \verb|CYGWIN| to the value \verb|nodosfilewarning|. (CYGWIN may also
  give you messages if you try to use tar to unpack the tar ball. If so,
  set the environment variable \verb|TAR_OPTIONS| to
\verb|--no-same-owner --no-same-permissions|.)\\
  To set environment variables in Windows 7:\\
  Open System Properties (e.g., right-click My Computer and select Properties);
   go to Advanced System Settings;
    select the Advanced tab, then click Environment Variables;
    under the System Variables section, click New;
    in the Variable name field, enter \verb|CYGWIN|;
    in the Variable value field, enter \verb|nodosfilewarning|;
    click OK on each of the dialogs to save your settings.
    Restart your computer.
\item When this one is OK, type\\
\verb|R CMD INSTALL RSiena_1.0.n.tar.gz|\\
(where \verb|n| is adjusted to match the file you have just created.)
\item You now should have a new version of the package ready for use. (If on 64
  bit Windows or Mac, you will have two versions, and you will have two copies
  of the source directories.)
\item \emph{Experts only!} Alternatively, instead of the build and INSTALL, just
  type
  \verb|R CMD INSTALL RSiena|\\
  If you have a 64-bit Windows and R 2.12.0, or a 64-bit Mac, use
  \verb|R CMD INSTALL --no-multiarch RSiena|\\
  instead. After the first compile, where using
  \verb|R CMD INSTALL --preclean RSiena| \\is recommended, this will just
  compile the C that has changed and then do the rest.  Quicker if you are
  debugging changes. Note that the \sfn{make} file is not very clever: if you
  are altering the C and your changes are not appearing, delete the .o's or .dll
  to force it, or use
  \verb|R CMD INSTALL --preclean RSiena|\\
  to clear out all the .o's and the dll. (\verb|R CMD build| used to clear out
  .o's but it does not from R 2.13.0) Also use \verb|--preclean| if you have
  changed any .h files: the make file is not aware which files depend on which
  headers.
\item If you use \verb|R CMD INSTALL --no-multiarch RSiena|
you get object files in the source tree. If you later want to build multi
architectures (where the object files are created in a copy of the source tree)
you need to use \verb|--preclean| to stop confusion between the different object
files.
\item On linux or Mac, the same commands should work, but you don't need the
  Rtools. I have occasionally had problems with installing from a tarball or
  from source, when I have no permission to write in the standard libraries. In
  that case, the easiest thing to do is
  open up R, and do \\
\verb|install.packages('xtable')| \\which should create a
  local library directory for you.
\end{enumerate}
\subsection{Checking the amended package}
\begin{enumerate}
\item Either run \verb|R CMD check RSiena|, or do a build, and then
  run \verb|R CMD check RSiena_1.0.n.tar.gz|. This will create a directory
  called \verb|RSiena.Rcheck|, and produce some diagnostics to the
  screen.
\item Please set environment variables to ensure you have tested everything you
  can. On platforms other than Windows you will need to create a \sfn{Makevars}
  file too. Details below. You should have no warnings at all from
  the tar ball version, maybe some to do with presence of object files with the
  other version.
\item Final check of pdf: once the warnings have gone away, do a visual check on
  the pdf version of the help pages which will be in the directory
  RSiena.RCheck. Check any pages you have changed for lines that are too long:
  the usage section, I think, does not wrap automatically.
\item If you just want to check the format of the help pages in the pdf, you can
  use \\ \verb|R CMD Rd2dvi --pdf man| \\ or e.g.\ \\
  \verb|R CMD --pdf man/siena7.Rd|\\ which will create a file called Rd2.pdf.
\end{enumerate}
\paragraph{Environment variables and Makevars}
 \label{below}
 The easiest way to control building and checking is to use environment
 variables. For portability between computers I suggest you set these using
 files as described here. You need a directory \verb|.R| in your home directory
 and two files in that directory.
 To find out what is your home directory:
\begin{description}
\item on Unix/Linux, open a terminal and type the command \verb|echo $HOME|
\item on Windows, open a command-prompt and type the command
    \verb|echo %USERPROFILE%| \\
    Alternatively, in the Start menu in the ``Search programs and files'' box,
    type \verb|command.com| and this will open a command prompt in
    the home directory.
    If these two ways give different directories,
    then you may try out both of them.
\item on a Mac, the home directory can be accessed by
    choosing \verb|Home| from the \verb|Go| menu in the Finder
    or by clicking on the \verb|Home| icon in a Finder window.
\end{description}
 Knowing how to get to your home directory, do the following:
\begin{description}
\item[.R directory] Create, in your home directory, a directory called .R (on
  Windows you can use mkdir in a command prompt window to do this).
\item[check.Renviron] This file is used in the check procedure. It should
 contain at least the following:
{\small
\begin{verbatim}
_R_CHECK_CODETOOLS_PROFILE_="suppressPartialMatchArgs=FALSE,
suppressLocalUnused=FALSE"
_R_CHECK_SRC_MINUS_W_UNUSED_=TRUE
\end{verbatim}
}
with no line break between the two options for CodeTools.

You could also add
\begin{verbatim}
RSIENA_TESTING=TRUE
\end{verbatim}
to turn on our automated testing system (see section \ref{sec:tests}).

To use your own personal library tree for the check, add to this file a line
containing: \verb|R_LIBS_USER=xxx|, where \verb|xxx| is the name of the directory
containing your installed packages.

You might like to add \verb|_R_CHECK_FORCE_SUGGESTS_=FALSE| which stops the
check failing because some suggested packages which are not actually used in the
code are not installed. (If you do this, you will get some warnings about "no
visible global function definition for...". Do read them to make sure that only
functions in the missing packages are mentioned.)

\item[build.Renviron] This is the file used for the build procedure.  I suggest
  you set \verb|CYGWIN=nodosfilewarning| here. (Only necessary in Windows but
  will do no harm on Mac or Linux.). We also used to need
\begin{verbatim}
_R_BUILD_RESAVE_DATE=no
\end{verbatim}
but this is now set in the DESCRIPTION file.
\item[Makevars] Currently only necessary on Mac and Linux, unless you have built
  your own R. This file is used to over-ride the system flags for compiling. Use
  the following line to set some warnings on for C++:
 \begin{verbatim}
CXXFLAGS=-g -O2 -Wall -pedantic
\end{verbatim}
You can also use other flags here too.
If you want to turn off optimisation (eg for valgrind), alter the O2 to a O0.
\end{description}
\paragraph{Alternative methods for small changes}
Good news: from R 2.12.0 it is often possible to update the R functions in
RSiena without re-installing the
package.
\begin{enumerate}
\item If you make a change to an R source file, you can override the package
  simply by using the R command \verb|insertSource|. For example,
  \verb|insertSource('d:/RSiena/R/phase1.r', package='RSiena')| will update any
  functions which you have altered which are contained in \verb|phase1.r|.
\item Alternatively, you can make a small change to a hidden file by using
  \verb|fixInNamespace('function name', 'RSiena')|.  This is useful to insert a
  call to \sfn{browser}, as you probably won't mind it disappearing when you
  exit from R.
\item It is likely that neither of these methods will work with S3 methods
  eg. print.sienaFit. If the function you are trying to alter does not call any
  hidden functions in RSiena, just source it and bypass the despatch mechanism
  but calling it directly. (Or add \verb|RSiena:::| in front of all calls to
  hidden functions.)
\end{enumerate}
\paragraph{Making  binaries}
If you want to send someone a Windows binary for some reason: on a Windows
machine, use

\verb|R CMD INSTALL --build RSiena|

Remember that you should send them the source tar ball too, for compliance with
GPL licensing.

If you are lucky the same will work with Mac binaries on a Mac but there may be
problems with differing versions of Mac OSX.

There is a facility to build Windows packages on CRAN. See
\url{http://win-builder.r-project.org/}. In the future there may be something
similar for Macs.
\section{Personal/private keys}
\label{key}
You can set up a personal/private ssh key pair so you do not need to type the
R-forge password. The details for Windows are: (linux and Mac users can probably
find our how to do this by googling).
\begin{enumerate}
\item Install \sfn{putty.exe} and its associated programs using the putty
  Windows installer for the whole set from
  {\small{\url{http://www.chiark.greenend.org.uk/~sgtatham/putty/}}}
\item After installation, run \sfn{putty.exe} and create a session for rforge:
Use \sfn{rforgename@svn.r-forge.r-project.org} as the host name. (Use your
r-forge name in place of \verb|rforgename|.)
\item Port should be 22
\item Connection type should be \verb|ssh|.
\item Save the session with name \verb|rforge|.
\item In TortoiseSVN, check out the source using the address
  \verb|svn+ssh://rforge/svnroot/rsiena| to check your session address is
  correct. You will have to type the password twice.
\item Make the key:
\begin{enumerate}
\item Run \sfn{puttygen.exe}.
\item You want \sfn{SSH-2 RSA}.
\item Click \sfn{Generate}
\item Move mouse over the blank area until the key has been generated.
\item Save Private Key
\end{enumerate}
\item Login to R-forge
\item Go to Account Maintenance/Edit Keys
\item Copy the public key from the puttygen window and paste into the R-forge
  window.
\item Click Update
\item Open your putty window, load the r-forge session and find the SSH/Auth
  page.
\item Put the name (complete path) of your private key file in the box provided.
\item Defaults for other fields should be OK. (On mine the two boxes  `Attempt
  authentication via Pageant' and `Attempt keyboard-interactive auth (SSH-2)'
  are checked.)
\item Go back to the session screen (you need to scroll up the left panel!) and
  save the session again.
\item An hour later, try it out by doing another secure checkout. You should not
  be asked for your password this time.
\end{enumerate}
\section{Testing}
Some testing is done automatically  by the \sfn{R CMD check} procedure. This
includes all examples on help pages except parts marked \sfn{\textbackslash
  dontrun} or \sfn{\textbackslash donttest}.

Since the checking is done every day by other people, we are limited as to the
amount of their time we are allowed to use up. There are now extra testing
facilities designed to be run by ourselves only. They should be run every time a
significant change is made.  Testing of the scripts is via the check procedure
after setting the environment variable \sfn{RSIENA\_TESTING} to any non-null
value. Other tests need to be run separately.
\label{sec:tests}
\begin{description}
\item[scripts] There is a file \sfn{scripts.R} in the \sfn{tests} directory
  which is designed to test the scripts in the manual. Since the
 \sfn{.Random.Seed} was altered in different ways on different platforms by
  \sfn{plot.network} the \sfn{sna}, \sfn{network} etc code has been moved to a
  separate script file with ``SNA'' in its name.  The
  scripts are concatenated (numbers added to the names make this happen in
  the correct order) and run, after copying all the files from the examples
  directory to the testing one. Any scripts which contain the text ``SNA'' in the
  name are ignored. Some difference output will typically be produced: check
  manually that it does not look important.

  There are two sets of different output: \sfn{scriptfile.Rout.save} and
  \sfn{scriptfile.Rout.win}, for Mac/Linux and Windows respectively. If you
  change the scripts, you need to update the reference copies by running the
  check, checking that nothing untoward has altered and then copying
  \sfn{scriptfile.Rout} to the tests directory of the r-forge source for the
  package and renaming it as scriptfile.Rout.save or scriptfile.Rout.win as
  appropriate. (Obviously if you have no access to one or more of the platforms
  you cannot do this for all, so you may find that it needs doing even if you
  have not changed the scripts but happen to be the first person checking on a
  particular platform since the scripts have been changed.)

  It is worth occasionally updating the files \sfn{parallel.Rout.save} and
  \sfn{scripts.Rout.save} just to reduce the differences. But do the latter
  after you have fixed the scriptfile.Rout differences. It would be appreciated
  if the differences in \sfn{scripts.Rout.save} are a minimum when \emph{not}
  running the tests of the scripts, as this is what appears every time the
  package is checked on CRAN.

Some notes about the testing of scripts:
\begin{enumerate}
\item R CMD CHECK is done using an R without any
  environment variables or initialization files except those in
  \textasciitilde/R/check.Renviron.
\item When doing the examples and ``normal'' tests within R CMD check, the
  directory containing the package under test will be prepended to the path to
  search when loading packages,
\item Testing the scripts is done by a subordinate R process, launched with the
  options "--vanilla" so it has no environment variables or initialisation
  files except the environment variables passed down from the launching process,
  which will include the path to search when loading packages,
\item If you have a personal library which needs to be included in the check
  procedure (eg xtable is somewhere unusual), set the environment variable
  \sfn{R\_LIBS\_USER} to this directory \emph{within
    \textasciitilde/R/check.Renviron}. Do not set \sfn{R\_LIBS} here as this is
  probably the mechanism for getting the package under test into the load path.
\item I have added a few commented out debugging statements to \sfn{scripts.R}
  which might help if you need to find out what is going on.
\item If this is inadequate, more flexibility could be obtained by replacing
 the call to \sfn{system()} in \sfn{scripts.R} by one to \sfn{system2()}.
\item When testing the scripts within \sfn{RSienaTest} it is necessary to have a
  package \sfn{RSiena} installed, preferably the one from R-forge or CRAN and
  not an altered version.
\end{enumerate}


\item[other tests]
There is a file \sfn{effectsTest.R} in the \sfn{tests} directory. It is
deliberately excluded from the tar ball, using \sfn{.Rbuildignore}, along with
the test output references: \sfn{test\textbackslash testrefs} and a subsidiary R
files \sfn{sampson.r}. It takes a
long time, but does a lot of tests. To run it, navigate to the \sfn{tests}
directory of your source and use
\begin{verbatim}
R CMD BATCH --no-save "--args startNo=1 endNo=65 doRun=1
useMult=1 useRSiena=1"  effectsTest.R
\end{verbatim}
(with no carriage return.)  You might find that single quotes work: it depends
on the shell. There are some notes about the arguments at the start of the
file. The output is a set of files named Compare.. or compare... which are
automatically checked against the files in the directory \sfn{testrefs}. There
are 65 tests. To run just test 22, use \verb|startNo=22| and \verb|endNo=22|. To
run under \sfn{valgrind} (very slow!) use
\begin{verbatim}
R -d "valgrind --tool=memcheck --track-origins=yes
--leak-check=full" --nosave --args startNo=1 endNo=65 doRun=1
useMult=0 useRSiena=1 < effectsTest.R
\end{verbatim}
But remove the carriage return.  You will get different results on 32 bit
Windows, which have not so far been stored for comparison. The tests have
frequently failed for no apparent reason, although the most recent bug fix may
have sorted this. It is wise to
be prepared to restart from any failure point. Check the existing results by
hand first as they will be deleted on restart:
\begin{verbatim}
diff testdir/*ompare* testrefs | more
\end{verbatim}
If new features are added, more tests will be needed. Many bugs were uncovered
by these tests, so it is important to keep the suite up to date and run it from
time to time. There maybe some rounding differences between platforms. These are
in general caused by printing after using the \sfn{round} function: the rounding
in the printing is done by the operating system, not \sfn{R}.

\end{description}
\section{Parallel runs}
Most of RSiena is set up to produce the same results as Siena3, but some effects
have been redefined and maximum likelihood uses a different algorithm.
\begin{enumerate}
\item In Siena3324xx source file \textsf{rangen.pas}, edit the lines at the
  bottom so that \textsf{version = 5} and \textsf{version2 = 6}.
\item Build siena01, siena07
\item Set the random seed to something non-zero (I use 1 but the value
  should not matter) in the .MO file.
\item It often helps to select the option to use standard starting values in the
  .MO file. This is necessary for the automatic parallel tests.
\item In R, use the argument \textsf{parallelTesting=TRUE} in the call to
  \textsf{siena07}.
\item Use the module \textsf{simstats0c} as the function when creating the
  model.
\end{enumerate}
\paragraph{Automatic tests}
\begin{enumerate}
\item
Select the correct versions of the random number generator as above.
\item Build  siena03, siena01, siena07
\item The automatic system needs some test files in the siena3324xx directory:
\begin{description}
\item[VRND32T3.DAT]
\item[VRND32T4.DAT]
\item[time23.dat]
\item[tmp34.in]
\item[effectsTest.bat]
\end{description}
There are more than one version of these data files around. The first two should
be the same as the objects tmp3 and tmp4 in RSiena. Use the same time23.dat file
in each case.
\item Create a directory in the siena3 directory called effectsTest.
\item  run \verb|siena01 tmp34|
\item Set the random seed to something non-zero (I use 1 but the value
  should not matter) in the .MO file.
\item Select the option to use standard starting values in the
  .MO file.
\item Set the number of subphases in phase2 to 2, and the number of iterations
  in phase3 to 100.
\item At the command prompt type\\
\verb|sh < effectsTest.bat|
\item and wait... (not so long now!)
\item when finished you should have 4 txt files to diff with the R ones:
  comp.txt, compc.txt, compfd.txt, compfdc.txt. They will not be exactly the
  same...
\item The R part is run by the command (somewhere else with a subdirectory
  called effectsTest, containing time23.dat):
 \verb|R --vanilla < effectsTest.R|
\item The R .txt files are in the effectsTest subdirectory, the siena3324 ones
  are in the main directory.
\item The subdirectories contain the .cck files and the equivalent from R, in
  files called things like eval\%.tmp, endow\%.tmp.
\item The .out files are stored in 4 parts: sienanonc.out, sienac.out,
  sienafdnonc.out, sienafd.out.
\item The detailed files can be used to find out more about runs that did not
  match.
\end{enumerate}
\section{Profiling}
If you are interested in knowing where RSiena spends its time, you can examine
the R part by:
\begin{verbatim}
Rprof()
siena07(...)
Rprof(NULL)
summaryRprof()
\end{verbatim}
For the C part it is a lot harder. We have an out-of-date system for running
\sfn{gprof} which could be updated if desired.  An outline of the use of
is given here:
\begin{enumerate}
\item Our set-up works for networks, behavior variables and the various
  covariates. 1 group only.
\item You will need a standalone RMath library. You can find out how to create
  this in the R-admin manual.
\item Run siena07 with the extra argument \textsf{profileData=TRUE}.
\item This creates a file called \textsf{data.txt}. Move this to the directory
  \textsf{src}.
\item In R, run the code, assuming the effects object is called \textsf{myeff}
  and you have nothing valuable called \textsf{tmp}:
\begin{verbatim}
tmp <- myeff[myeff$include,c(1,4,7,13,14,5,6,17,21,23,16)]
tmp[tmp==""] <- NA
write.table(tmp, 'effects.txt', quote=FALSE, row.names=FALSE,
col.names=FALSE, na="NA")
\end{verbatim}
\item This creates a file called \textsf{effects.txt}.  Move this to the
  directory \textsf{src}.
\item In the \textsf{src} directory,
\begin{verbatim}
make -f makefile.profile clean
make -f makefile.profile
SienaProfile.exe
gprof SienaProfile.exe gmon.out > gprof.out
more gprof.out
\end{verbatim}
\item You will need to adjust the \textsf{RHOME} line in
  \textsf{makefile.profile} to reflect the location of R on your system.
\item Google for ``gprof'' to find out how to understand the output!
\end{enumerate}

There are alternatives on linux (\textsf{oprofile}) or Mac OS (\textsf{shark},
or
\textsf{Instruments/TimeProfiler}).
A few notes about each:
\begin{description}
\item[oprofile]
\begin{enumerate}
\item You need root privileges to start or stop the daemon, and to reset it. I
  suggest using it on an Ubuntu installation of your own to avoid permission
  problems. There are instructions on CRAN about how to install R on
  Ubuntu. There is a Windows Installer to create Ubuntu alongside a Windows
  installation which is easy to use. Alternatively, install Ubuntu from the
  download. In either case, take care to defragment and check your disk first as
  it will be repartitioned and this can cause problems if it is highly
  fragmented.
\item It is a resource hog.
\item The callgraph option only used to work on 32 bit machines but seems to
  work ok on 64 bit now. It will not work if you have optimization level
  \emph{O3} on the compiler.
\item \verb|opcontrol --start| to start it
\item \verb|opcontrol --callgraph=5| to get a callgraph.
\item \verb|opcontrol --reset| to start the collection again
\item May need to change buffer sizes: eg
\verb|opcontrol --buffer-size=10000000|
\verb|opcontrol --buffer-watershed=2500000|
\verb|opcontrol --cpu-buffer-size=1000000|
\item Then run the R command
\item \verb|opcontrol --dump| to create a file you can get reports from.
Follow by \verb|opcontrol --shutdown| to avoid errors due to files not being in
the expected place.
\item \verb|opreport -l RSiena.so| to get a report.
\item \verb|opannotate -d src srcdir| to get annotated output
\item \verb|ogprof path/to/RSiena.so| to create output like \sfn{gprof}.
Follow by
\verb|gprof path/to/RSiena.so > my.out| to store the report in \sfn{my.out}.
\item \verb|opcontrol --shutdown| to stop daemon
\item Read the help: all this will probably change!
\end{enumerate}
\item[shark]
\begin{enumerate}
\item Make sure shark is installed. Not available in Xcode 4 (lion)
\item Start it
\item Run your R command
\item Attach shark to this command.
\item During the run, click Start and then Stop  on the Shark window
\item If you have the right settings a callgraph will appear in Shark.
\item I found that saving the results usually failed to work.
\item This route and TimeProfiler are the only ones I found which would include
  C functions like exp in the profiling, although it is possible you may find a
  profiled gcc math library available for a Linux installation.
\end{enumerate}
\item[TimeProfiler]
\begin{enumerate}
\item Start Instruments and select TimeProfiler
\item Use ChooseTarget to attach to the R process
\item Click Record and later Stop
\item You can get some sort of callgraph, but not the total time spent in a
  procedure.
\item Mac Lion has started asking for permissions repeatedly. Not sure what the
  problem is.
\end{enumerate}
\end{description}

In any of these cases, you may find results vary due to garbage
collection in R. Also changes which speed up the Mac may not speed up Windows,
particularly changing memory allocation.
\section{Debugging}

\subsection{Debugging R}
Refer to session 7 of my R programming slides.
\subsection{Debugging C++}
You may find that R tends to crash when you change the C++. You can try to trap
the error using \sfn{Rprintf} statements to print out details at intervals. The
syntax for \sfn{Rprintf} is the same as the C function \sfn{printf}, but output
from the R version appears in the R console where other output will not. You
need the header file \sfn{"R\_ext/Print.h"} which may already be included. To
print out R objects (arguments or objects you have created in the C++), use
\sfn{PrintValue(xx)} for any \sfn{SEXP} \sfn{xx}: this requires the header file
\sfn{Rinternals.h}.

For debugging chains there are utility functions \textsf{getChainDF} and similar
which create a data frame from a ministep or a chain. Within C++, you can use
\textsf{PrintValue(getChainDF(...));} to produce a readable output of the
chain. There is an option to sort if you want to check how many of a particular
link occur. For initial and end states there is a more sophisticated version
which adds these as attributes and a corresponding R print method to display
them. As always, you can use sink() to get console output to a file.

If you have access to a Linux machine, you can use a program called
\sfn{valgrind} to find places where you access memory which you should not, and
similar things. The usage is described in the Writing R Extensions manual. I
use, at the command line,\\
\sfn{R -d "valgrind --tool=memcheck --leak-check=full " --vanilla < valgrind.r}
\\
where valgrind.r contains the commands I want to run, \emph{followed by
  \sfn{gc()}} to do some R garbage collection. (Otherwise \sfn{valgrind} reports
a lot of still reachable memory at the end.)

\sfn{valgrind} will also report memory leaks which may not cause an error, just
an embarrassingly large memory usage, which will fail sooner or later.

If \sfn{valgrind} reports use of uninitialised variables, use the option
\sfn{--track-origins=yes} to find out where the problem started. It can be
surprisingly difficult to track these down! But it usually reports some from R,
and the C++ library which you can ignore.

\sfn{valgrind} should work on a Mac, but may not. It is worth a try: get the
source from the svn, and follow their install instructions. It may help to build
your own R.

\sfn{valgrind} does not find everything: it may help to use a specially built
version of R with instrumentation for \sfn{valgrind}, with or without
\sfn{gctorture} if the problem may be in the interface between R and C++. More
details in the manual Writing R extensions.

It is possible to use a debugger on the C: Details of
this are also in the Writing R extensions manual.

\section{The R C++ interface}
This is not easy to understand from the documentation (Writing R Extensions
manual), but there should be examples of most functions in the code
already. Some notes:
\begin{description}
\item[random numbers]
We use the R random number functions such as \sfn{rexp}. These work slightly
differently from the R versions, you need to check the syntax of the call in
the manual if adding new ones. The header required is \sfn{Rmath.h}. We use
\sfn{unif\_rand} rather than \sfn{runif} probably to enable profiling to
work where we had to run outside R.

\item[Random number seeds] The functions\sfn{GetRNGstate} and
\sfn{PutRNGstate}  are used to get the R random number seed into the C++
process and then replace it in the R. The header for these is
\sfn{R\_ext/Random.h}.
\item[rlecuyer]
With multiple processes we used to use the random numbers from the \sfn{rlecuyer}
package. The seed is set in eg \sfn{robmon} (in the R code). There is code in
\sfn{siena07models.cpp} which shows how to set and reset these if you must. The
different streams are intended to be kept apart, so for finite differencing
where we need common random number streams we advance to a new substream at
the beginning of each real iteration and reset to this point at the beginning of
each finite difference one. The jump to the new substream ignores the current
state so it does not matter if the streams get muddled up during the finite
differencing stage. As from R version 2.14.0 this package can be removed as
there is a new type of random number within R itself, to be used with the
new \sfn{parallel} package. For the time being the original code can be run if
desired by replacing the 3 checks for R.version less than 14.0 by TRUE.
\item[errors]
Error messages can use the function \sfn{error} which is similar to
\sfn{Rprintf} in syntax, and needs the header file \sfn{R\_ext/error.h}.
\item[Interrupt processing] There is a function provided to make C++ interrupts
  return to R rather than die completely. It needs to be called at the start:
  generally one sets up data first, so it is called in the function
  \sfn{setUpData}.
\end{description}
\section{C++ platform independence}
A few notes of problems we have had:
\begin{itemize}
\item With some compilers you need to add \sfn{<string>} if you use
  \sfn{<stdexcept>}. Often this will be included somewhere else in the path, but
  if you add \sfn{<stdexcept>} it would be good to add \sfn{<string>} also.
  \item Be careful with \sfn{abs}. The integer version is in \sfn{<cstdlib>} not
    \sfn{<cmath>}. Compilation may fail with message about ambiguity.
\item Make sure you use the C++ version of headers, not the C ones. Even so,
  there are warnings about anachronisms on Solaris.
\end{itemize}
\section{Algorithms}
This section outlines some different options available to the (expert!) user via
the functions \sfn{algorithms} and \sfn{profileLikelihoods} (exported, help
pages available) The functions are in the
  package \sfn{RSienaTest}.

  The basic outline is described here. The parameters are passed to the
  initialize routine and then stored on \sfn{z}. Hopefully their use will be
  fairly clear if you read what follows (and the code!)

No promises about robustness, and the routine is designed to be hacked rather
than run unchanged. But examples of use are in file \sfn{inst/examples/runalg.r}.

The graphs are semi-automatic, driven by a dataframe with a column for each
panel. Consult the code to see how it works: construct a formula from the column
names. It is a nice trick. There is no parameter to turn them off: comment them
out.

\sfn{}
\subsection{Outline processing}
\begin{algorithmic}
\STATE Call AlgorithmsInitialize \ref{sec:init}
\REPEAT
\STATE
\REPEAT
\IF{using optim}
\IF{not finalLoop}
\STATE set number of samples for this iteration from optim schedule
\ENDIF
\STATE set the importance sampling weights to 1
\ENDIF
\STATE get the next set of samples: \ref{sec:samples}
\REPEAT
\IF{using optim}
\STATE store the old theta
\STATE do an optim update step: \ref{sec:optim}
\STATE get importance sampling weights at new theta
\IF {variance of weights high or more than maxiiter repeats or no change in
theta}
\STATE break
\ENDIF
\ELSIF {response surface}
\STATE do a reponse surface change step \ref{sec:resp}
\STATE break
\ELSE
\STATE do an algorithm change step: \ref{sec:algchange}
\IF{final loop and theta has not changed much}
\STATE break
\ENDIF
\STATE get predicted values (\ref{sec:pred}) and importance sampling weights at
new theta
\IF{variance of importance sampling weights is large or more than
  \sfn{maxiiter} repeats}
\STATE break
\ENDIF
\ENDIF
\UNTIL{for ever}
\STATE update the plots
\IF {using C storage}
\STATE clear the stores
\ENDIF
\IF {using history for optim}
\STATE store the samples
\ENDIF
\UNTIL{completed \sfn{numiter} iterations or more than \sfn{maxiiter} importance
sampling steps and still low variance or final loop}
\IF {not finalLoop}
\STATE set finalLoop to TRUE
\STATE set up things for final iteration: \ref{sec:final}
\ELSE
\STATE break
\ENDIF
\UNTIL{for ever}
\STATE Do termination call to C
\STATE Close any open processes
\end{algorithmic}
\subsubsection{Initialize}
\label{sec:init}
\begin{algorithmic}
\STATE call initializeFRAN to set data up in C
\STATE Store all the options on \sfn{z}
\STATE create useful variables (Some of this is done automatically now in
  \sfn{initialiseFRAN} so this function could be pruned.)
\STATE set finalLoop to FALSE
\end{algorithmic}
\subsubsection{Get next set of samples}
\label{sec:samples}
\begin{algorithmic}
\STATE get the samples with their likelihoods
\STATE calculate derivative matrix if required
\end{algorithmic}
\subsubsection{Optim change step}
\label{sec:optim}
\begin{algorithmic}
\STATE 2 functions provided: mean log likelihood (EM) or log mean
probability ratios (GT)
\STATE Derivative calculation routines to match (hope these are correct!)
\STATE Default method is BFGS
\STATE Default is just 1 iteration until final loop
\STATE Rates need logging unless you use L-BFGS-B. The functions take exp() at
the start.
\STATE Step length is limited to distance of the scale.
\STATE With EM you can reuse the historical samples downweighted by factor of
optimWeight each time.
\STATE EM uses importance sampling weights
\end{algorithmic}
\subsubsection{Response surface step}
\label{sec:resp}
\begin{algorithmic}
\STATE Use importance sampling to estimate the statistics at points around the
current parameter.
\STATE Create a data frame with these and (down-weighted) previous results.
\STATE Fit a linear regression and solve for targets 0
\STATE Move is restricted to distance the scale factor.
\STATE There is a routine to fit a quadratic instead, and minimise the distance
from targets 0, but it does not work well. Usually not positive definite. Maybe
code is wrong. It uses raw orthogonal polynomials.
\end{algorithmic}
\subsubsection{Non optim change step}
\label{sec:algchange}
\begin{algorithmic}
\STATE Uses a copy of the phase 2 update step from siena07, with diagonal or full
derivative matrix as requested.
\end{algorithmic}
\subsubsection{Predictions}
\label{sec:pred}
\begin{algorithmic}
\STATE Get the log likelihoods
\STATE Subtract the values for the smaple
\STATE Exponentiate
\STATE Normalise to sum to 1
\IF {variance greater than maxVar}
\STATE make predictions NA
\ELSE
\STATE multiply by statistics or scores
\ENDIF
\end{algorithmic}
\subsubsection{Calculating likelihoods and probabilities}
For speed and maintainability, this is done in C. There is an option to return
likelihoods for each iteration, and another to pass new parameters in to obtain
an updated likelihood (and optionally scores) for a specified (by group, period
and index) chain.
\subsubsection{Set up final iteration}
\label{sec:final}
\begin{algorithmic}
\STATE set \sfn{diag} flag off so use whole derivative matrix
\STATE reduce the gain to stop erratic behavior
\STATE set number of samples to finalIter
\STATE restart iteration count
\IF {using optim}
\STATE set maxit to 100
\STATE set maxiiter to 0
\STATE set optimFn to optimFinal
\STATE set useOptim to useOptimFinal: could do Newton-Raphson type updates
instead.
\ELSE
\STATE set maxiiter to 20
\ENDIF
\end{algorithmic}
\end{document}
